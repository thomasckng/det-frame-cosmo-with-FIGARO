\documentclass[aps,prd,twocolumn,superscriptaddress,preprintnumbers,nofootinbib,hidelinks]{revtex4-2}

\usepackage{showyourwork}
\usepackage{amsfonts,amssymb,amsmath}
\usepackage[nolist,nohyperlinks]{acronym}
\usepackage{bookmark}
\usepackage{orcidlink}
\usepackage{mathtools}

\newcommand{\todo}[1]{\textcolor{red}{[TODO: #1]}}
\newcommand{\ste}[1]{\textcolor{blue}{[Ste: #1]}}

\begin{document}

\title{Inferring cosmology from gravitational waves using non-parametric detector-frame mass distribution}

\author{Thomas~C.~K.~Ng\,\orcidlink{0000-0002-9491-1598}}
\email{thomas.ng@link.cuhk.edu.hk}
\affiliation{Department of Physics, The Chinese University of Hong Kong, Shatin, Hong Kong}

\author{Stefano~Rinaldi\,\orcidlink{0000-0001-5799-4155}}
\email{stefano.rinaldi@uni-heidelberg.de}
\affiliation{Institut~für~Theoretische~Astrophysik, ZAH, Universität~Heidelberg, Albert-Ueberle-Stra{\ss}e~2, 69120 Heidelberg, Germany}
\affiliation{Dipartimento di Fisica e Astronomia ``G. Galilei'', Università di Padova, Via Marzolo 8, 35122 Padova, Italy}

\author{Otto~A.~Hannuksela\,\orcidlink{0000-0002-3887-7137}}
\email{hannuksela@phy.cuhk.edu.hk}
\affiliation{Department of Physics, The Chinese University of Hong Kong, Shatin, Hong Kong}

\begin{abstract}
    The challenge of understanding the Universe's dynamics, particularly the Hubble tension, requires precise measurements of the Hubble constant.
    Building upon the existing spectral siren method, which capitalizes on population information from gravitational wave sources, this study explores an alternative way to analyze the population data to obtain the cosmological parameters in $\Lambda$CDM.
    We will focus on how non-parametric methods, which are flexible models that can be used to agnostically reconstruct arbitrary probability densities, can be incorporated into this framework and leverage the detector-frame mass distribution to infer the cosmological parameters.
    \todo{Rewrite abstract}
\end{abstract}

\maketitle

\begin{acronym}
    \acro{GW}{gravitational wave}
    \acro{LVK}{LIGO-Virgo-KAGRA Collaboration}
    \acro{PE}{parameter estimation}
    \acro{CMB}{cosmic microwave background}
    \acro{EM}{electromagnetic}
    \acro{(H)DPGMM}{hierarchy of Dirichlet process Gaussian mixture model}
    \acro{BBH}{binary black hole}
    \acro{GWTC-3}{the third Gravitational-Wave Transient Catalog}
\end{acronym}

\section{Introduction}
\label{sec:introduction}

% Motivation
In recent years, the precision of cosmological measurements has improved significantly, leading to the discovery of the Hubble tension, a discrepancy between the value of the Hubble constant $H_0$ inferred from the \ac{CMB} \citep{Planck:2018vyg} and local measurements \citep{Riess:2021jrx}.
This tension has motivated the search for new methods to measure $H_0$ with high precision, and \ac{GW} sources have emerged as a promising tool for this purpose.
To infer $H_0$ from \ac{GW} sources, one needs not only the luminosity distance which can be inferred from the signal but also the redshift of the source.
Some \ac{GW} sources can be associated with \ac{EM} counterparts, allowing for the measurement of the redshift, e.g., GW170817 \citep{LIGOScientific:2017adf, Guidorzi:2017ogy}.
However, most \ac{GW} sources do not have \ac{EM} counterparts. \todo{Add galaxy catalog method}
In this case, one can use population statistics to infer $H_0$ by marginalizing the redshift distribution of the sources.
This method is known as the spectral siren method\citep{You:2020wju, Mastrogiovanni:2021wsd, LIGOScientific:2021aug, Ezquiaga:2022zkx}.
\ste{You should mention that the galaxy catalog method also exists and cite some more relevant papers (e.g. Schutz 1986, Del Pozzo 2012, Farr et al. 2019). References \texttt{\href{ https://onlinelibrary.wiley.com/doi/pdf/10.1002/andp.202200180}{here}}}

% Previous work
The fundamental idea of the spectral siren method is to assume a population model for the mass distribution of the sources and marginalize over the redshift distribution to infer the cosmological parameters.
Many studies have explored different variations of the spectral siren method.
\todo{Summarize previous work and add references}

% What's new?
\ste{Instead of immediately describing what we will do in the paper, I think you should add a brief description of non-parametric methods and then guide the reader to the same idea that we had (nonpar methods can reconstruct whatever distribution we want $\rightarrow$ cosmology must be involved to reconstruct astro dist $\rightarrow$ detector-frame dist `freezes' the cosmology and can be predicted using astro models + cosmological parameters $\rightarrow$ comparison with observations). Then you can briefly sketch what we present in the paper and summarise its content. It's more appealing and easy to understand if instead of presenting the reader with a bunch of facts you make them think with yow, somewhat like a lecture.}
In this study, we explore an alternative method based on the spectral siren framework.
We propose two major modifications to the standard spectral siren method.
First, instead of transforming the individual posterior samples from the detector frame to the source frame during the \ac{PE} process, we transform the population model to the detector frame before performing \ac{PE}.
Second, instead of computing the likelihood of the observed data given the population model, we reconstruct the detector-frame observed population directly from the data using a non-parametric method.

\ste{I see what you're doing here, and it's ok, but I'd present this as `benefits' of this approach, rather than our aims.}
With these modifications, we aim to separate the spectral siren method into two distinct parts.
The first part is the reconstruction of the observed population from the data, which does not require any assumptions about the population model, and the intermediate result is completely data-driven.
Other assumptions including the population model, cosmological model and selection function are then incorporated in the second half.
This separation allows us to explore the impact of different assumptions easily.
The intermediate result of the first part can be reused as long as the data does not change, reducing the computational cost of the method.
\todo{Add references}
\todo{More events in the future}

% Section outline
In Sec.~\ref{sec:method}, we describe our modified method and the testing procedure.
In Sec.~\ref{sec:results}, we present the results of our method.
In Sec.~\ref{sec:discussion}, we compare our result with other methods and discuss future directions.
Finally, we conclude in Sec.~\ref{sec:conclusion} with a summary.
\todo{Rewrite outline}

\section{Method}
\label{sec:method}
\ste{In this section, we present the framework we developed to infer the cosmological parameters leveraging on the detector-frame mass distribution. In the remainder of this Section, we will make use of the following notation, mutuated from Rinaldi et al. (2024? 2022?): ...}
Our method consists of three main steps: the non-parametric reconstruction of the detector-frame observed population, the transformation of the source-frame population model to the detector frame, and the \ac{PE}.
We show the flowchart of our method in Fig.~XXX. \todo{Add flowchart}

\subsection{Non-parametric reconstruction of detector-frame observed population}
\label{sec:reconstruction}

The first step of our method is to reconstruct the detector-frame observed population.
we choose to consider the primary mass $m_1$ of the \ac{BBH} sources, in principle, we can consider more parameters at once.
From the posterior samples obtained from the \ac{PE} of each \ac{GW} event, we reconstruct the detector-frame observed mass distribution $p(m^z_1|\mathbf{Y})$, where $\mathbf{Y}$ is the set of posterior samples of all \ac{GW} events.

To perform the reconstruction, we use a non-parametric reconstruction package \textsc{figaro}\footnote{\textsc{figaro} is publicly available at \url{https://github.com/sterinaldi/FIGARO} and via \texttt{pip}.} \citep{Rinaldi:2022kyg}.
Using \textsc{figaro}, we perform a \ac{(H)DPGMM} to reconstruct $p(m^z_1|\Theta_i(\mathbf{Y}))$ with samples from all single-event \ac{PE} posterior \citep{Rinaldi:2021bhm}, and $\Theta_i$ are the hyperparameters of the \ac{(H)DPGMM} for a single reconstruction.
\ste{Here it should be the other way around. We use (H)DPGMM as non-parametric model to reconstruct the observed detector-frame mass distribution -- you may want to extremely briefly summarise it here -- and then you mention the fact that the numerical implementation we use is \textsc{figaro}.}

Performing the reconstruction once will give a distribution $p(m^z_1|\Theta_i(\mathbf{Y}))$ that is consistent with $\mathbf{Y}$ with a given set of hyperparameters $\Theta_i$.
To account for the uncertainty in the reconstruction, we need to perform the reconstruction multiple times to obtain a set of distributions $p(m^z_1|\mathbf{\Theta}(\mathbf{Y}))$, where $\mathbf{\Theta}$ is a set of $\Theta_i$.
The uncertainty of the reconstruction can then be quantified by the spread of the distributions.
\todo{Mention the reconstruction holds only in the region with samples}
In Fig.~XXX \todo{Add figure}, we show an example of the reconstruction obtained with \textsc{figaro}.

This part of the method is completely data-driven.
Therefore the intermediate result is independent of the population, cosmological model and selection function, and we can reuse the result for testing different models.
This reduces the computational cost of the method, as we only need to perform the reconstruction once to analyze different models.

\subsection{Transformation of source-frame population model}
\label{sec:transformation}

On the other hand, we need a source-frame population model $p(m_1|\Lambda)$ to represent the underlying population of the sources, where $\Lambda$ is the population model.
\todo{Change to function of mass and redshift}
We can either use a parametric model to only assume the form of the population distribution, or we can use a fixed population model to assume the exact population distribution.
With $p(m_1|\Lambda)$, we need to transform it to the detector frame with a given cosmological model to obtain the detector-frame population model $p(m^z_1|\Lambda, \Omega)$, where $\Omega$ is the cosmological model.
With different $\Omega$, $p(m_1|\Lambda)$ will be transformed differently, and the resulting $p(m^z_1|\Lambda, \Omega)$ will be different.
By considering a continuous set of $\Omega$ and  $\Lambda$ of the population model, we can obtain a set of $p(m^z_1|\mathbf{\Lambda}, \mathbf{\Omega})$, which is a set of continuous detector-frame intrinsic population models for each combination of $\Omega_j$ and $\Lambda_j$, where $\mathbf{\Lambda} = \{\Lambda_j\}$ and $\mathbf{\Omega} = \{\Omega_j\}$.\footnote{In practice, we use a discrete set of $\Omega_j$ and $\Lambda_j$ with a small step size in their hyperparameters to approximate the continuous set.}
\ste{This following sentence should be the very last sentence of this subsection, since it opens for the following PE description.} 
After obtaining $p(m^z_1|\mathbf{\Lambda}, \mathbf{\Omega})$, we can perform the \ac{PE} to infer the best-fit $\Omega_j$ and $\Lambda_j$.
\todo{PE\textrightarrow Inference of Cosmological Parameters}
\todo{Add selection function} \ste{In the selection function part, you may also want to specify why we opted for reconstructing the observed distribution and not the intrinsic one with (H)DPGMM (namely the censoring of a specific portion of the parameter space).}
In Fig.~XXX \todo{Add figure}, we show an example of the transformation.

Opposite to the first part of the method, this part includes the assumptions about the population and cosmological model, as well as the selection function.

\subsection{Parameter estimation}
\label{sec:pe}

With $p(m^z_1|\mathbf{\Theta}(\mathbf{Y}))$ and $p(m^z_1|\mathbf{\Lambda}, \mathbf{\Omega})$ obtained from Sec.~\ref{sec:reconstruction} and Sec.~\ref{sec:transformation} respectively, we can perform the \ac{PE} to infer the free parameters in the parametric models assumed in Sec.~\ref{sec:transformation}.
The \ac{PE} is performed by comparing $p(m^z_1|\Theta_i(\mathbf{Y}))$ with $p(m^z_1|\Lambda_j, \Omega_j)$.
To compare the two populations, we use the Jensen–Shannon distance $d_{JS}$ as the distance measure.
$d_{JS}$ is calculated as
\begin{equation}
    d_{JS}(p, q) = \sqrt{\frac{D_{KL}(p||m) + D_{KL}(q||m)}{2}},
\end{equation}
where $p$ and $q$ are the two distributions to be compared, $m = (p + q) / 2$, and $D_{KL}$ is the Kullback–Leibler divergence.
$d_{JS}$ is a symmetric and smoothed version of $D_{KL}$, and it is bounded between 0 and 1.

For each reconstructed distribution $p(m^z_1|\Theta_i(\mathbf{Y}))$, we find the best-fit $\Lambda_j$ and $\Omega_j$ by minimizing $d_{JS}$.
\todo{add the cutting of the low and high mass}
This procedure gives us a set of best-fit $\Lambda_i$ and $\Omega_j$ for each $\Theta_i$.
Note that the resulting distribution of the best-fit parameters is not a posterior distribution in the Bayesian sense, as we do not consider the likelihood of the observed data given the population model.
Instead, it is a distribution of the best-fit parameters that are consistent with the observed data, distributed according to the uncertainty in the reconstruction of the population.
That is, the uncertainty in the comparison of the two populations is not considered in the resulting distribution.
By considering this optimization procedure only, we can estimate the best-fit parameters without performing computationally expensive likelihood calculations.
In Fig.~XXX \todo{Add figure}, we show an example of the fitting procedure.
\todo{Add minimization process}

\section{Analysis}
\label{sec:analysis}

\subsection{Simulation}
\label{sec:injection-setup}

\subsection{Real data}
\label{sec:real-data-setup}
Data from \citet{LIGOScientific:2019lzm, KAGRA:2023pio}

\section{Results}
\label{sec:results}

\subsection{Simulation}
\label{sec:injection-results}

% $H_0$ only

% $H_0$ and $\Lambda$

\subsection{Real data}
\label{sec:real-data-results}

% Power law + peak

% Population model from simulation

\section{Discussion}
\label{sec:discussion}

% Comparison with other methods

% PL+P issue
    % Gregoire Pierra's paper

% Future directions
    % Likelihood
    % luminosity distance/redshift population 

\section{Conclusion}
\label{sec:conclusion}

\begin{acknowledgments}
T.N.~ and S.R.~ acknowledge financial support from the German Excellence Strategy via the Heidelberg Cluster of Excellence (EXC 2181 - 390900948) STRUCTURES.
S.R.~ acknowledges financial support from the European Research Council for the ERC Consolidator grant DEMOBLACK, under contract no. 770017. 

This research made use of the bwForCluster Helix: the authors acknowledge support by the state of Baden-Württemberg through bwHPC and the German Research Foundation (DFG) through grant INST 35/1597-1 FUGG.

This research has made use of data or software obtained from the Gravitational Wave Open Science Center (gwosc.org), a service of the LIGO Scientific Collaboration, the Virgo Collaboration, and KAGRA. This material is based upon work supported by NSF's LIGO Laboratory which is a major facility fully funded by the National Science Foundation, as well as the Science and Technology Facilities Council (STFC) of the United Kingdom, the Max-Planck-Society (MPS), and the State of Niedersachsen/Germany for support of the construction of Advanced LIGO and construction and operation of the GEO600 detector. Additional support for Advanced LIGO was provided by the Australian Research Council. Virgo is funded, through the European Gravitational Observatory (EGO), by the French Centre National de Recherche Scientifique (CNRS), the Italian Istituto Nazionale di Fisica Nucleare (INFN) and the Dutch Nikhef, with contributions by institutions from Belgium, Germany, Greece, Hungary, Ireland, Japan, Monaco, Poland, Portugal, Spain. KAGRA is supported by Ministry of Education, Culture, Sports, Science and Technology (MEXT), Japan Society for the Promotion of Science (JSPS) in Japan; National Research Foundation (NRF) and Ministry of Science and ICT (MSIT) in Korea; Academia Sinica (AS) and National Science and Technology Council (NSTC) in Taiwan.

This paper was compiled using \textsc{showyourwork} \cite{Luger2021} to facilitate reproducibility.

\end{acknowledgments}

\bibliography{bib}

\end{document}
